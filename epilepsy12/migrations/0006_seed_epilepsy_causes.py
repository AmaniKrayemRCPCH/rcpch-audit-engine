# Generated by Django 4.2 on 2023-04-24 11:46

from django.db import migrations

from ..general_functions import fetch_ecl


def seed_epilepsy_causes(apps, schema_editor):
    """
    This returns all the snomed ct definitions and codes for epilepsy causes.
    Should be run periodically to compare with value in database and update record if has changed
    """

    # Get models
    EpilepsyCause = apps.get_model("epilepsy12", "EpilepsyCause")

    print("\033[33m", "Seeding all the epilepsy causes from SNOMED...", "\033[33m")
    if EpilepsyCause.objects.count() == 200:
        print("Causes already exist. Skipping this step...")
        return
    index = 0
    ecl = "<< 363235000"
    # calls the rcpch deprivare server for a list of causes using ECL query language
    epilepsy_causes = fetch_ecl(ecl)
    for cause in epilepsy_causes:
        new_cause = EpilepsyCause(
            conceptId=cause["conceptId"],
            term=cause["term"],
            preferredTerm=cause["preferredTerm"],
        )
        try:
            new_cause.save()
            index += 1
        except Exception as e:
            print(f"Epilepsy cause {cause['preferredTerm']} not added. {e}")
    print(f"{index} epilepsy causes added")


class Migration(migrations.Migration):
    dependencies = [
        ("epilepsy12", "0005_seed_organisations"),
    ]

    operations = [migrations.RunPython(seed_epilepsy_causes)]
